<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi√®vres ‚Äî Simulateur Hypoth√©caire Belge</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81' },
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom range slider ‚Äî filled track via linear-gradient */
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; border-radius: 9999px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 3px solid #6366f1; transition: box-shadow 0.15s; position: relative; z-index: 2; }
        .dark input[type="range"] { background: #374151; }
        .light-mode input[type="range"] { background: #d1d5db; }
        .dark input[type="range"]::-webkit-slider-thumb { background: #1e1b4b; box-shadow: 0 0 0 3px rgba(99,102,241,0.3); }
        .light-mode input[type="range"]::-webkit-slider-thumb { background: #fff; box-shadow: 0 0 0 3px rgba(99,102,241,0.3); }
        input[type="range"]::-webkit-slider-thumb:hover { box-shadow: 0 0 0 6px rgba(99,102,241,0.25); }
        input[type="range"]::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 3px solid #6366f1; }
        .dark input[type="range"]::-moz-range-thumb { background: #1e1b4b; }
        .light-mode input[type="range"]::-moz-range-thumb { background: #fff; }
        input[type="range"]::-moz-range-progress { background: #6366f1; border-radius: 9999px; height: 6px; }

        /* Smooth transitions */
        * { transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        input[type="range"], input[type="range"]::-webkit-slider-thumb { transition: background-color 0.3s, box-shadow 0.15s; }

        /* Toggle switch */
        .toggle-track { width: 56px; height: 28px; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.3s; }
        .toggle-thumb { width: 22px; height: 22px; border-radius: 50%; background: white; position: absolute; top: 3px; left: 3px; transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle-track.active .toggle-thumb { transform: translateX(28px); }

        /* Glassmorphism cards */
        .glass-card { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

        /* Animation */
        @keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        .animate-in { animation: fadeInUp 0.5s ease-out forwards; }
        .animate-in-delay-1 { animation-delay: 0.1s; opacity: 0; }
        .animate-in-delay-2 { animation-delay: 0.2s; opacity: 0; }
        .animate-in-delay-3 { animation-delay: 0.3s; opacity: 0; }

        /* PEB badges */
        .peb-btn { padding: 6px 14px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .peb-btn.selected { transform: scale(1.1); box-shadow: 0 0 0 3px rgba(99,102,241,0.4); }
        .peb-A { background: #22c55e; color: white; }
        .peb-B { background: #84cc16; color: white; }
        .peb-C { background: #eab308; color: white; }
        .peb-D { background: #f97316; color: white; }
        .peb-E { background: #ef4444; color: white; }
        .peb-F { background: #dc2626; color: white; }
        .peb-G { background: #991b1b; color: white; }

        /* Gauge */
        .gauge-ring { transition: stroke-dashoffset 0.8s ease-in-out; }

        /* Number input */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .result-value { font-variant-numeric: tabular-nums; }

        /* Scenario cards */
        .scenario-card { position: relative; }
        .scenario-card .scenario-remove { opacity: 0; transition: opacity 0.2s; }
        .scenario-card:hover .scenario-remove { opacity: 1; }
        .scenario-badge { display: inline-block; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-size: 0.75rem; font-weight: 700; }

        /* Sticky mobile bar */
        .mobile-sticky-bar { display: none; }
        @media (max-width: 1023px) {
            .mobile-sticky-bar { display: flex; position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; padding: 10px 16px; gap: 12px; align-items: center; justify-content: space-between; border-top: 1px solid rgba(55,65,81,0.5); }
            .dark .mobile-sticky-bar { background: rgba(3,7,18,0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
            .light-mode .mobile-sticky-bar { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-color: rgba(209,213,219,0.5); }
            body { padding-bottom: 64px; }
        }

        /* Toast notification */
        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-10px); opacity: 0; } }
        .toast { animation: toastIn 0.3s ease-out forwards; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; padding: 10px 20px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; pointer-events: none; }
        .toast.out { animation: toastOut 0.3s ease-in forwards; }
        @media (min-width: 1024px) { .toast { bottom: 24px; } }

        /* Collapsible detail */
        .detail-toggle-icon { transition: transform 0.2s; }
        .detail-toggle-icon.open { transform: rotate(180deg); }

        /* Header responsive */
        @media (max-width: 640px) {
            .header-controls { flex-direction: column; gap: 8px; align-items: flex-end; }
            .header-controls .region-row { order: 2; }
        }
    </style>
</head>
<body class="dark bg-gray-950 text-gray-100 min-h-screen font-sans">

    <!-- Header -->
    <header class="sticky top-0 z-50 glass-card border-b border-gray-800/50 bg-gray-950/80">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2z"/></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight">Back to Chi√®vres</h1>
                    <p class="text-xs text-gray-400">Simulateur hypoth√©caire belge</p>
                </div>
            </div>
            <div class="flex items-center gap-4 header-controls">
                <!-- Region toggle -->
                <div class="flex items-center gap-2 text-sm region-row">
                    <span id="labelWallonie" class="font-medium text-white">Wallonie</span>
                    <div id="regionToggle" class="toggle-track bg-brand-600" onclick="toggleRegion()">
                        <div class="toggle-thumb"></div>
                    </div>
                    <span id="labelBruxelles" class="font-medium text-gray-400">Bruxelles</span>
                </div>
                <div class="w-px h-6 bg-gray-700 hidden sm:block"></div>
                <!-- Dark/Light toggle -->
                <button id="themeBtn" onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-800 transition-colors" title="Changer de th√®me">
                    <svg id="iconMoon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    <svg id="iconSun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 lg:py-10">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">

            <!-- LEFT COLUMN ‚Äî Inputs -->
            <div class="lg:col-span-5 space-y-5 animate-in">

                <!-- Prix + Apport (grouped) -->
                <div class="card-section rounded-2xl p-5 bg-gray-900 border border-gray-800">
                    <div class="flex items-center justify-between mb-1">
                        <label class="text-sm font-semibold text-gray-300">Prix du bien</label>
                        <span id="priceDisplay" class="text-xl font-bold text-brand-400 result-value">350 000 ‚Ç¨</span>
                    </div>
                    <input type="range" id="price" min="100000" max="1200000" step="5000" value="350000" oninput="calculate()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>100 000 ‚Ç¨</span><span>1 200 000 ‚Ç¨</span>
                    </div>
                    <div class="border-t border-gray-800 mt-4 pt-4">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-sm font-semibold text-gray-300">Apport personnel</label>
                            <span id="downPaymentDisplay" class="text-xl font-bold text-brand-400 result-value">50 000 ‚Ç¨</span>
                        </div>
                        <input type="range" id="downPayment" min="0" max="500000" step="1000" value="50000" oninput="calculate()">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0 ‚Ç¨</span><span>500 000 ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <!-- Revenus nets mensuels -->
                <div class="card-section rounded-2xl p-5 bg-gray-900 border border-gray-800 animate-in animate-in-delay-2">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-sm font-semibold text-gray-300">Revenus nets mensuels (m√©nage)</label>
                    </div>
                    <div class="relative">
                        <input type="number" id="income" value="3500" min="0" step="50"
                            class="w-full px-4 py-3 pr-12 rounded-xl bg-gray-800 border border-gray-700 text-white text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                            oninput="calculate()">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">‚Ç¨/mois</span>
                    </div>

                    <!-- Expandable: revenus compl√©mentaires -->
                    <button onclick="toggleExtras()" class="mt-3 flex items-center gap-2 text-xs font-medium text-brand-400 hover:text-brand-300 transition-colors">
                        <svg id="extrasChevron" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                        Revenus compl√©mentaires (vision banque)
                    </button>
                    <div id="extrasPanel" class="hidden mt-3 space-y-3 pl-1 border-l-2 border-brand-500/30 ml-1 py-2 pl-4">
                        <p class="text-xs text-gray-500 leading-relaxed mb-2">La banque peut prendre en compte ces √©l√©ments pour √©valuer votre capacit√© d'emprunt.</p>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 block mb-1">13·µâ mois / P√©cule <span class="text-gray-600">(annuel)</span></label>
                                <div class="relative">
                                    <input type="number" id="bonus13" value="0" min="0" step="100"
                                        class="w-full px-3 py-2 pr-8 rounded-lg bg-gray-800 border border-gray-700 text-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-brand-500"
                                        oninput="calculate()">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs">‚Ç¨</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 block mb-1">Bonus annuel <span class="text-gray-600">(~60% pris)</span></label>
                                <div class="relative">
                                    <input type="number" id="bonusAnnual" value="0" min="0" step="100"
                                        class="w-full px-3 py-2 pr-8 rounded-lg bg-gray-800 border border-gray-700 text-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-brand-500"
                                        oninput="calculate()">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs">‚Ç¨</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 mt-1">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="companyCar" class="w-4 h-4 rounded border-gray-600 text-brand-500 focus:ring-brand-500 bg-gray-800" onchange="calculate()">
                                <span class="text-xs text-gray-400">Voiture de soci√©t√© <span class="text-gray-600">(+450 ‚Ç¨/mois de reste √† vivre)</span></span>
                            </label>
                        </div>
                        <div class="mt-2 rounded-lg bg-brand-500/10 border border-brand-500/20 px-3 py-2">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-brand-300">Revenu ajust√© banque</span>
                                <span id="adjustedIncomeDisplay" class="text-sm font-bold text-brand-400 result-value">‚Äî ‚Ç¨/mois</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Taux + Dur√©e (grouped) -->
                <div class="card-section rounded-2xl p-5 bg-gray-900 border border-gray-800 animate-in animate-in-delay-2">
                    <div class="flex items-center justify-between mb-1">
                        <label class="text-sm font-semibold text-gray-300">Taux d'int√©r√™t annuel</label>
                        <span id="rateDisplay" class="text-xl font-bold text-brand-400 result-value">3.20%</span>
                    </div>
                    <input type="range" id="rate" min="0.5" max="6" step="0.05" value="3.2" oninput="calculate()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>0,50%</span><span>6,00%</span>
                    </div>
                    <div id="pebBonusNote" class="hidden mt-2 text-xs text-green-400 font-medium">
                        ‚ú® Bonus PEB : -0,15% appliqu√© ‚Üí taux effectif : <span id="effectiveRateNote"></span>
                    </div>
                    <div class="border-t border-gray-800 mt-4 pt-4">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-sm font-semibold text-gray-300">Dur√©e du pr√™t</label>
                            <span id="durationDisplay" class="text-xl font-bold text-brand-400 result-value">25 ans</span>
                        </div>
                        <input type="range" id="duration" min="5" max="30" step="1" value="25" oninput="calculate()">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>5 ans</span><span>30 ans</span>
                        </div>
                    </div>
                </div>

                <!-- Score PEB -->
                <div class="card-section rounded-2xl p-5 bg-gray-900 border border-gray-800 animate-in animate-in-delay-3">
                    <label class="text-sm font-semibold text-gray-300 block mb-3">Score PEB du bien</label>
                    <div class="flex gap-2 flex-wrap">
                        <button class="peb-btn peb-A" onclick="selectPEB('A', this)">A</button>
                        <button class="peb-btn peb-B" onclick="selectPEB('B', this)">B</button>
                        <button class="peb-btn peb-C selected" onclick="selectPEB('C', this)">C</button>
                        <button class="peb-btn peb-D" onclick="selectPEB('D', this)">D</button>
                        <button class="peb-btn peb-E" onclick="selectPEB('E', this)">E</button>
                        <button class="peb-btn peb-F" onclick="selectPEB('F', this)">F</button>
                        <button class="peb-btn peb-G" onclick="selectPEB('G', this)">G</button>
                    </div>
                </div>

                <!-- ASRD (Assurance Solde Restant D√ª) -->
                <div class="card-section rounded-2xl p-5 bg-gray-900 border border-gray-800 animate-in animate-in-delay-3">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-semibold text-gray-300">Assurance solde restant d√ª</label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="asrdEnabled" class="w-4 h-4 rounded border-gray-600 text-brand-500 focus:ring-brand-500 bg-gray-800" onchange="toggleASRD()">
                            <span class="text-xs text-gray-400">Inclure</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 leading-relaxed mb-3">Quasi obligatoire en Belgique. Prot√®ge le remboursement en cas de d√©c√®s.</p>
                    <div id="asrdPanel" class="hidden space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 block mb-1">√Çge de l'emprunteur</label>
                                <div class="relative">
                                    <input type="number" id="asrdAge" value="30" min="18" max="65" step="1"
                                        class="w-full px-3 py-2 pr-10 rounded-lg bg-gray-800 border border-gray-700 text-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-brand-500"
                                        oninput="calculate()">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs">ans</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 block mb-1">Couverture</label>
                                <select id="asrdCoverage" class="w-full px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-brand-500" onchange="calculate()">
                                    <option value="1">100%</option>
                                    <option value="0.5">50% (couple)</option>
                                </select>
                            </div>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="asrdSmoker" class="w-4 h-4 rounded border-gray-600 text-brand-500 focus:ring-brand-500 bg-gray-800" onchange="calculate()">
                            <span class="text-xs text-gray-400">Fumeur <span class="text-gray-600">(+60% sur la prime)</span></span>
                        </label>
                        <div class="rounded-lg bg-brand-500/10 border border-brand-500/20 px-3 py-2">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-brand-300">Prime unique estim√©e</span>
                                <span id="asrdSinglePremium" class="text-sm font-bold text-brand-400 result-value">‚Äî</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-xs text-brand-300">√âquivalent mensuel</span>
                                <span id="asrdMonthlyDisplay" class="text-sm font-bold text-brand-400 result-value">‚Äî</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN ‚Äî Results -->
            <div class="lg:col-span-7 space-y-5">

                <!-- Feasibility Gauge -->
                <div id="feasibilityCard" class="rounded-2xl p-6 bg-gray-900 border border-gray-800 animate-in">
                    <div class="flex flex-col sm:flex-row items-center gap-6">
                        <!-- Gauge SVG -->
                        <div class="relative flex-shrink-0">
                            <svg width="140" height="140" viewBox="0 0 140 140">
                                <circle cx="70" cy="70" r="58" fill="none" stroke="currentColor" stroke-width="10" class="text-gray-800" />
                                <circle id="gaugeRing" cx="70" cy="70" r="58" fill="none" stroke="#22c55e" stroke-width="10"
                                    stroke-dasharray="364.42" stroke-dashoffset="200"
                                    stroke-linecap="round" transform="rotate(-90 70 70)" class="gauge-ring" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="gaugePercent" class="text-2xl font-bold result-value">0%</span>
                                <span class="text-[10px] text-gray-400 uppercase tracking-wider">Endettement</span>
                            </div>
                        </div>
                        <!-- Feasibility info -->
                        <div class="flex-1 text-center sm:text-left">
                            <div id="feasLabel" class="text-lg font-bold mb-1">Analyse en cours‚Ä¶</div>
                            <p id="feasDesc" class="text-sm text-gray-400 leading-relaxed"></p>
                            <div class="mt-3 grid grid-cols-2 gap-3">
                                <div class="rounded-xl bg-gray-800/60 p-3">
                                    <div class="text-xs text-gray-400 mb-0.5">Mensualit√©</div>
                                    <div id="monthlyResult" class="text-lg font-bold result-value">‚Äî</div>
                                </div>
                                <div class="rounded-xl bg-gray-800/60 p-3">
                                    <div class="text-xs text-gray-400 mb-0.5">Reste √† vivre</div>
                                    <div id="remainResult" class="text-lg font-bold result-value">‚Äî</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Figures -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 animate-in animate-in-delay-1">
                    <div class="rounded-2xl p-4 bg-gray-900 border border-gray-800 text-center">
                        <div class="text-xs text-gray-400 mb-1">Besoin de financement</div>
                        <div id="financingNeed" class="text-base sm:text-lg font-bold text-white result-value">‚Äî</div>
                    </div>
                    <div class="rounded-2xl p-4 bg-gray-900 border border-gray-800 text-center">
                        <div class="text-xs text-gray-400 mb-1">Co√ªt total du cr√©dit</div>
                        <div id="totalCost" class="text-base sm:text-lg font-bold text-white result-value">‚Äî</div>
                    </div>
                    <div class="rounded-2xl p-4 bg-gray-900 border border-gray-800 text-center">
                        <div class="text-xs text-gray-400 mb-1">Quotit√© (LTV)</div>
                        <div id="ltvDisplay" class="text-base sm:text-lg font-bold text-white result-value">‚Äî</div>
                    </div>
                    <div class="rounded-2xl p-4 bg-gray-900 border border-gray-800 text-center">
                        <div class="text-xs text-gray-400 mb-1">Frais totaux</div>
                        <div id="totalFees" class="text-base sm:text-lg font-bold text-white result-value">‚Äî</div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="rounded-2xl p-6 bg-gray-900 border border-gray-800 animate-in animate-in-delay-2">
                    <h3 class="text-sm font-semibold text-gray-300 mb-4">R√©partition du co√ªt total</h3>
                    <div class="flex flex-col sm:flex-row items-center gap-6">
                        <div class="w-full sm:w-1/2 max-w-[280px]">
                            <canvas id="costChart"></canvas>
                        </div>
                        <div id="chartLegend" class="flex-1 space-y-3 text-sm w-full"></div>
                    </div>
                </div>

                <!-- Detail breakdown (collapsible) -->
                <div class="rounded-2xl bg-gray-900 border border-gray-800 animate-in animate-in-delay-3">
                    <button onclick="toggleFeeDetail()" class="w-full flex items-center justify-between p-6 cursor-pointer hover:bg-gray-800/30 rounded-2xl transition-colors">
                        <h3 class="text-sm font-semibold text-gray-300">D√©tail des frais</h3>
                        <svg id="feeDetailIcon" class="w-5 h-5 text-gray-500 detail-toggle-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div id="feeDetailPanel" class="hidden px-6 pb-6">
                        <div class="space-y-2 text-sm" id="feeBreakdown"></div>
                    </div>
                </div>

                <!-- Scenario Save Button -->
                <div class="flex gap-3 animate-in animate-in-delay-3">
                    <button onclick="saveScenario()" class="flex-1 py-3 px-4 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-semibold text-sm transition-colors flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                        Sauvegarder ce sc√©nario
                    </button>
                    <button id="clearScenariosBtn" onclick="clearScenarios()" class="hidden py-3 px-4 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-400 font-medium text-sm transition-colors">
                        Effacer tout
                    </button>
                </div>

                <!-- Scenario Comparison -->
                <div id="scenarioSection" class="hidden rounded-2xl p-6 bg-gray-900 border border-gray-800 animate-in">
                    <h3 class="text-sm font-semibold text-gray-300 mb-4">üìä Comparaison de sc√©narios</h3>
                    <div id="scenarioGrid" class="grid gap-4"></div>
                    <div id="scenarioTable" class="mt-4 overflow-x-auto"></div>
                </div>

            </div>
        </div>
    </main>

    <!-- Mobile Sticky Bar -->
    <div class="mobile-sticky-bar" id="mobileBar">
        <div class="flex items-center gap-3 flex-1 min-w-0">
            <div class="text-center">
                <div class="text-[10px] text-gray-400 uppercase tracking-wider leading-none mb-0.5">Mensualit√©</div>
                <div id="stickyMonthly" class="text-base font-bold text-white result-value leading-tight">‚Äî</div>
            </div>
            <div class="w-px h-8 bg-gray-700 flex-shrink-0"></div>
            <div class="text-center">
                <div class="text-[10px] text-gray-400 uppercase tracking-wider leading-none mb-0.5">Endettement</div>
                <div id="stickyDebt" class="text-base font-bold result-value leading-tight">‚Äî</div>
            </div>
            <div class="w-px h-8 bg-gray-700 flex-shrink-0"></div>
            <div class="text-center">
                <div class="text-[10px] text-gray-400 uppercase tracking-wider leading-none mb-0.5">Reste √† vivre</div>
                <div id="stickyRemain" class="text-base font-bold text-white result-value leading-tight">‚Äî</div>
            </div>
        </div>
        <button onclick="document.getElementById('feasibilityCard').scrollIntoView({behavior:'smooth'})" class="p-2 rounded-lg bg-brand-600 text-white flex-shrink-0" title="Voir r√©sultats">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
        </button>
    </div>

    <!-- Toast container -->
    <div id="toastContainer"></div>

    <!-- Footer -->
    <footer class="text-center py-6 text-xs text-gray-600 border-t border-gray-800/50 mt-10">
        <p>Chi√®vres ‚Äî Simulation indicative, ne constitue pas un conseil financier. Donn√©es fiscales 2025-2026.</p>
    </footer>

<script>
    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let region = 'wallonie'; // 'bruxelles' | 'wallonie'
    let pebScore = 'C';
    let isDark = true;
    let chart = null;
    let savedScenarios = []; // max 3
    let lastCalcResult = null; // store latest calculation for scenario saving

    // ‚îÄ‚îÄ‚îÄ Theme Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleTheme() {
        isDark = !isDark;
        const html = document.documentElement;
        const body = document.body;
        if (isDark) {
            html.classList.add('dark');
            html.classList.remove('light-mode');
            body.classList.add('dark', 'bg-gray-950', 'text-gray-100');
            body.classList.remove('light-mode', 'bg-gray-50', 'text-gray-900');
            document.getElementById('iconMoon').classList.remove('hidden');
            document.getElementById('iconSun').classList.add('hidden');
            // Update all cards
            document.querySelectorAll('.card-section, .rounded-2xl.bg-gray-900').forEach(el => {
                el.classList.remove('bg-white', 'border-gray-200');
                el.classList.add('bg-gray-900', 'border-gray-800');
            });
            document.querySelectorAll('.bg-gray-100\\/60, .bg-gray-100').forEach(el => {
                el.classList.remove('bg-gray-100/60', 'bg-gray-100');
                el.classList.add('bg-gray-800/60', 'bg-gray-800');
            });
            // Header
            const header = document.querySelector('header');
            header.classList.remove('bg-white/80', 'border-gray-200/50');
            header.classList.add('bg-gray-950/80', 'border-gray-800/50');
        } else {
            html.classList.remove('dark');
            html.classList.add('light-mode');
            body.classList.remove('dark', 'bg-gray-950', 'text-gray-100');
            body.classList.add('light-mode', 'bg-gray-50', 'text-gray-900');
            document.getElementById('iconMoon').classList.add('hidden');
            document.getElementById('iconSun').classList.remove('hidden');
            // Update all cards
            document.querySelectorAll('.bg-gray-900').forEach(el => {
                el.classList.remove('bg-gray-900', 'border-gray-800');
                el.classList.add('bg-white', 'border-gray-200');
            });
            document.querySelectorAll('.bg-gray-800\\/60, .bg-gray-800').forEach(el => {
                el.classList.remove('bg-gray-800/60', 'bg-gray-800');
                el.classList.add('bg-gray-100/60', 'bg-gray-100');
            });
            // Header
            const header = document.querySelector('header');
            header.classList.remove('bg-gray-950/80', 'border-gray-800/50');
            header.classList.add('bg-white/80', 'border-gray-200/50');
        }
        updateChartColors();
    }

    // ‚îÄ‚îÄ‚îÄ Region Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleRegion() {
        const track = document.getElementById('regionToggle');
        const lW = document.getElementById('labelWallonie');
        const lB = document.getElementById('labelBruxelles');
        if (region === 'bruxelles') {
            region = 'wallonie';
            track.classList.remove('active');
            lW.classList.add('text-white'); lW.classList.remove('text-gray-400');
            lB.classList.remove('text-white'); lB.classList.add('text-gray-400');
        } else {
            region = 'bruxelles';
            track.classList.add('active');
            lB.classList.add('text-white'); lB.classList.remove('text-gray-400');
            lW.classList.remove('text-white'); lW.classList.add('text-gray-400');
        }
        calculate();
    }

    // ‚îÄ‚îÄ‚îÄ PEB Selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function selectPEB(score, btn) {
        pebScore = score;
        document.querySelectorAll('.peb-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        calculate();
    }

    // ‚îÄ‚îÄ‚îÄ Filled Range Track ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateFilledTrack(input) {
        const min = parseFloat(input.min);
        const max = parseFloat(input.max);
        const val = parseFloat(input.value);
        const pct = ((val - min) / (max - min)) * 100;
        const trackBg = isDark ? '#374151' : '#d1d5db';
        input.style.background = `linear-gradient(to right, #6366f1 0%, #6366f1 ${pct}%, ${trackBg} ${pct}%, ${trackBg} 100%)`;
    }

    function updateAllFilledTracks() {
        document.querySelectorAll('input[type="range"]').forEach(updateFilledTrack);
    }

    // ‚îÄ‚îÄ‚îÄ Toast Notification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        const bg = isDark ? 'bg-gray-800 text-white border border-gray-700' : 'bg-white text-gray-900 border border-gray-200 shadow-lg';
        toast.className = `toast ${bg}`;
        toast.textContent = msg;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('out'); }, 2000);
        setTimeout(() => { toast.remove(); }, 2300);
    }

    // ‚îÄ‚îÄ‚îÄ Fee Detail Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleFeeDetail() {
        const panel = document.getElementById('feeDetailPanel');
        const icon = document.getElementById('feeDetailIcon');
        panel.classList.toggle('hidden');
        icon.classList.toggle('open');
    }

    // ‚îÄ‚îÄ‚îÄ Sticky Bar Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateStickyBar(monthlyTotal, debtRatio, remaining) {
        document.getElementById('stickyMonthly').textContent = fmt(monthlyTotal);
        const stickyDebt = document.getElementById('stickyDebt');
        stickyDebt.textContent = debtRatio.toFixed(1).replace('.', ',') + '%';
        stickyDebt.classList.remove('text-green-400', 'text-orange-400', 'text-red-400');
        if (debtRatio < 35) stickyDebt.classList.add('text-green-400');
        else if (debtRatio <= 45) stickyDebt.classList.add('text-orange-400');
        else stickyDebt.classList.add('text-red-400');
        document.getElementById('stickyRemain').textContent = fmt(remaining);
    }

    // ‚îÄ‚îÄ‚îÄ Format helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function fmt(n) {
        return new Intl.NumberFormat('fr-BE', { maximumFractionDigits: 0 }).format(Math.round(n)) + ' ‚Ç¨';
    }
    function fmtShort(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1).replace('.', ',') + ' M‚Ç¨';
        if (n >= 10000) return Math.round(n / 1000) + ' k‚Ç¨';
        return fmt(n);
    }

    // ‚îÄ‚îÄ‚îÄ Fiscal Calculations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function calcRegistrationFees(price, region) {
        if (region === 'wallonie') {
            // 3% taux r√©duit habitation propre et unique
            return price * 0.03;
        } else {
            // Bruxelles : 12.5%
            // Abattement : 0% sur les premiers 200k si prix < 600k
            if (price <= 600000) {
                // Abattement sur les 200 000 premiers euros
                const taxable = Math.max(0, price - 200000);
                return taxable * 0.125;
            } else {
                return price * 0.125;
            }
        }
    }

    // ‚îÄ‚îÄ‚îÄ Bar√®me d√©gressif notaire belge (AR 1950, index√©) ‚îÄ‚îÄ
    function notaryFeesScale(amount) {
        const brackets = [
            { up: 7500, rate: 0.0456 },
            { up: 17500, rate: 0.0285 },
            { up: 30000, rate: 0.0228 },
            { up: 45495, rate: 0.0171 },
            { up: 64095, rate: 0.0114 },
            { up: 250095, rate: 0.0057 },
            { up: Infinity, rate: 0.00057 }
        ];
        let fees = 0, prev = 0;
        for (const b of brackets) {
            if (amount <= prev) break;
            fees += (Math.min(amount, b.up) - prev) * b.rate;
            prev = b.up;
        }
        return fees;
    }

    function calcNotaryFees(price) {
        // Honoraires (bar√®me d√©gressif r√©glement√©)
        const honoraires = notaryFeesScale(price);
        // TVA 21% sur les honoraires
        const tva = honoraires * 0.21;
        // Frais administratifs et de recherche
        const admin = 1100;
        return { honoraires, tva, admin, total: honoraires + tva + admin };
    }

    function calcMortgageDeedFees(loanAmount) {
        // Droit d'enregistrement sur l'acte hypoth√©caire : 1%
        const registrationTax = loanAmount * 0.01;
        // Droit d'inscription hypoth√©caire (conservation) : 0,3%
        const inscriptionFee = loanAmount * 0.003;
        // Honoraires du notaire pour l'acte de cr√©dit (m√™me bar√®me)
        const honoraires = notaryFeesScale(loanAmount);
        const tva = honoraires * 0.21;
        // Frais administratifs acte de cr√©dit
        const admin = 850;
        // Frais de dossier bancaire
        const dossierBank = 500;
        return {
            registrationTax, inscriptionFee, honoraires, tva,
            admin, dossierBank,
            total: registrationTax + inscriptionFee + honoraires + tva + admin + dossierBank
        };
    }

    // ‚îÄ‚îÄ‚îÄ ASRD Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleASRD() {
        const panel = document.getElementById('asrdPanel');
        const enabled = document.getElementById('asrdEnabled').checked;
        if (enabled) {
            panel.classList.remove('hidden');
        } else {
            panel.classList.add('hidden');
        }
        calculate();
    }

    // ‚îÄ‚îÄ‚îÄ ASRD Calculation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function calcASRD(loanAmount, durationYears, age, isSmoker, coverage) {
        // Prime unique estim√©e en % du capital (march√© belge)
        // Bas√© sur les tarifs moyens AG Insurance / Ethias / AXA
        let baseRate;
        if (age <= 25)      baseRate = 0.025;
        else if (age <= 30) baseRate = 0.035;
        else if (age <= 35) baseRate = 0.050;
        else if (age <= 40) baseRate = 0.070;
        else if (age <= 45) baseRate = 0.095;
        else if (age <= 50) baseRate = 0.135;
        else if (age <= 55) baseRate = 0.190;
        else if (age <= 60) baseRate = 0.270;
        else                baseRate = 0.350;

        // Majoration fumeur : +60%
        if (isSmoker) baseRate *= 1.60;

        // Ajustement dur√©e (normalis√© sur 20 ans)
        baseRate *= (0.70 + 0.30 * (durationYears / 20));

        // Appliquer la couverture
        baseRate *= coverage;

        const singlePremium = loanAmount * baseRate;
        const monthlyEquivalent = singlePremium / (durationYears * 12);

        return { singlePremium, monthlyEquivalent };
    }

    // ‚îÄ‚îÄ‚îÄ Extras Panel Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleExtras() {
        const panel = document.getElementById('extrasPanel');
        const chevron = document.getElementById('extrasChevron');
        panel.classList.toggle('hidden');
        chevron.style.transform = panel.classList.contains('hidden') ? '' : 'rotate(90deg)';
    }

    // ‚îÄ‚îÄ‚îÄ Adjusted Income (bank view) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getAdjustedIncome() {
        const baseIncome = parseFloat(document.getElementById('income').value) || 0;
        const bonus13 = parseFloat(document.getElementById('bonus13')?.value) || 0;
        const bonusAnnual = parseFloat(document.getElementById('bonusAnnual')?.value) || 0;
        const hasCar = document.getElementById('companyCar')?.checked || false;

        // 13√®me mois : liss√© sur 12 mois (100%)
        const monthly13 = bonus13 / 12;
        // Bonus annuel : banques prennent ~60%, liss√© sur 12 mois
        const monthlyBonus = (bonusAnnual * 0.6) / 12;
        // Voiture de soci√©t√© : +450‚Ç¨ de reste √† vivre estim√©
        const carBonus = hasCar ? 450 : 0;

        const adjusted = baseIncome + monthly13 + monthlyBonus + carBonus;

        const display = document.getElementById('adjustedIncomeDisplay');
        if (display) display.textContent = fmt(Math.round(adjusted)) + '/mois';

        return adjusted;
    }

    // ‚îÄ‚îÄ‚îÄ Main Calculation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function calculate() {
        const price = parseFloat(document.getElementById('price').value);
        const downPayment = parseFloat(document.getElementById('downPayment').value);
        const income = getAdjustedIncome();
        let rate = parseFloat(document.getElementById('rate').value);
        const years = parseInt(document.getElementById('duration').value);

        // PEB bonus
        const hasPEBBonus = (pebScore === 'A' || pebScore === 'B');
        const effectiveRate = hasPEBBonus ? Math.max(0.1, rate - 0.15) : rate;
        const pebNote = document.getElementById('pebBonusNote');
        if (hasPEBBonus) {
            pebNote.classList.remove('hidden');
            document.getElementById('effectiveRateNote').textContent = effectiveRate.toFixed(2).replace('.', ',') + '%';
        } else {
            pebNote.classList.add('hidden');
        }

        // Update displays
        document.getElementById('priceDisplay').textContent = fmt(price);
        document.getElementById('downPaymentDisplay').textContent = fmt(downPayment);
        document.getElementById('rateDisplay').textContent = rate.toFixed(2).replace('.', ',') + '%';
        document.getElementById('durationDisplay').textContent = years + ' ans';

        // ‚îÄ‚îÄ Frais d'achat (acte de vente) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const registrationFees = calcRegistrationFees(price, region);
        const notary = calcNotaryFees(price);
        const purchaseFees = registrationFees + notary.total;

        // ‚îÄ‚îÄ Calcul it√©ratif (frais hypoth√©caires d√©pendent du montant emprunt√©)
        let loanAmount = Math.max(0, price + purchaseFees - downPayment);
        let mortgage = calcMortgageDeedFees(loanAmount);
        for (let i = 0; i < 3; i++) {
            loanAmount = Math.max(0, price + purchaseFees + mortgage.total - downPayment);
            mortgage = calcMortgageDeedFees(loanAmount);
        }
        const totalFees = purchaseFees + mortgage.total;
        const financingNeed = loanAmount;

        // ‚îÄ‚îÄ Quotit√© (LTV) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const ltv = price > 0 ? (financingNeed / price) * 100 : 0;

        // Monthly payment calculation
        const P = financingNeed;
        const r = effectiveRate / 100 / 12;
        const n = years * 12;
        let monthly = 0;
        if (r > 0 && n > 0 && P > 0) {
            monthly = P * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
        } else if (n > 0 && P > 0) {
            monthly = P / n;
        }

        // ‚îÄ‚îÄ ASRD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const asrdEnabled = document.getElementById('asrdEnabled')?.checked || false;
        let asrd = { singlePremium: 0, monthlyEquivalent: 0 };
        if (asrdEnabled && P > 0) {
            const age = parseInt(document.getElementById('asrdAge')?.value) || 30;
            const isSmoker = document.getElementById('asrdSmoker')?.checked || false;
            const coverage = parseFloat(document.getElementById('asrdCoverage')?.value) || 1;
            asrd = calcASRD(P, years, age, isSmoker, coverage);
            document.getElementById('asrdSinglePremium').textContent = fmt(asrd.singlePremium);
            document.getElementById('asrdMonthlyDisplay').textContent = fmt(asrd.monthlyEquivalent) + '/mois';
        }
        const monthlyTotal = monthly + asrd.monthlyEquivalent;

        // Ratios (with ASRD included)
        const debtRatio = income > 0 ? (monthlyTotal / income) * 100 : 0;
        const remaining = income - monthlyTotal;
        const totalCredit = (monthly * n) - P;

        // Update results
        if (asrdEnabled && asrd.monthlyEquivalent > 0) {
            document.getElementById('monthlyResult').innerHTML = fmt(monthlyTotal) + `<span class="text-xs text-gray-500 block">(dont ASRD ${fmt(asrd.monthlyEquivalent)})</span>`;
        } else {
            document.getElementById('monthlyResult').textContent = fmt(monthly);
        }
        document.getElementById('remainResult').textContent = fmt(remaining);
        document.getElementById('financingNeed').textContent = fmtShort(financingNeed);
        document.getElementById('totalCost').textContent = fmtShort(totalCredit);

        // LTV display with color coding
        const ltvEl = document.getElementById('ltvDisplay');
        ltvEl.textContent = ltv.toFixed(0).replace('.', ',') + '%';
        ltvEl.classList.remove('text-green-400', 'text-orange-400', 'text-red-400', 'text-white');
        if (ltv <= 80) {
            ltvEl.classList.add('text-green-400');
        } else if (ltv <= 90) {
            ltvEl.classList.add('text-orange-400');
        } else {
            ltvEl.classList.add('text-red-400');
        }

        document.getElementById('totalFees').textContent = fmtShort(totalFees);

        // Feasibility
        updateFeasibility(debtRatio, remaining);

        // Chart (include ASRD in interest section for visual)
        const asrdTotal = asrd.singlePremium;
        updateChart(P, totalCredit, totalFees, asrdTotal);

        // Store last result for scenario saving
        lastCalcResult = {
            price, downPayment: downPayment, rate: effectiveRate, years, peb: pebScore, region,
            monthly, monthlyASRD: asrd.monthlyEquivalent, monthlyTotal,
            debtRatio, remaining, ltv, financingNeed, totalFees, totalCredit,
            asrdEnabled, asrdSingle: asrd.singlePremium,
            totalOperation: price + totalFees + totalCredit + asrdTotal
        };

        // Fee breakdown
        updateFeeBreakdown({ registrationFees, notary, mortgage, totalFees, price, financingNeed, monthly, monthlyTotal, asrd, asrdEnabled, n, totalCredit, effectiveRate, debtRatio, remaining, ltv });

        // Sticky mobile bar
        updateStickyBar(monthlyTotal, debtRatio, remaining);

        // Filled range tracks
        updateAllFilledTracks();
    }

    // ‚îÄ‚îÄ‚îÄ Feasibility Gauge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateFeasibility(debtRatio, remaining) {
        const ring = document.getElementById('gaugeRing');
        const circumference = 2 * Math.PI * 58; // ~364.42
        const pct = Math.min(debtRatio, 60);
        const offset = circumference - (pct / 60) * circumference;
        ring.style.strokeDashoffset = offset;

        const percentEl = document.getElementById('gaugePercent');
        percentEl.textContent = debtRatio.toFixed(1).replace('.', ',') + '%';

        const label = document.getElementById('feasLabel');
        const desc = document.getElementById('feasDesc');
        const card = document.getElementById('feasibilityCard');

        // Remove old colors
        ring.removeAttribute('stroke');
        card.classList.remove('border-green-500/30', 'border-orange-500/30', 'border-red-500/30');

        if (debtRatio < 35 && remaining > 1500) {
            ring.setAttribute('stroke', '#22c55e');
            percentEl.classList.remove('text-orange-400', 'text-red-400');
            percentEl.classList.add('text-green-400');
            label.textContent = '‚úÖ Projet r√©alisable';
            label.className = 'text-lg font-bold mb-1 text-green-400';
            desc.textContent = `Votre taux d'endettement de ${debtRatio.toFixed(1).replace('.', ',')}% est sous le seuil de 35% et votre reste √† vivre de ${fmt(remaining)} est confortable.`;
            card.classList.add('border-green-500/30');
        } else if (debtRatio <= 45) {
            ring.setAttribute('stroke', '#f59e0b');
            percentEl.classList.remove('text-green-400', 'text-red-400');
            percentEl.classList.add('text-orange-400');
            label.textContent = '‚ö†Ô∏è Projet tendu';
            label.className = 'text-lg font-bold mb-1 text-orange-400';
            desc.textContent = `Endettement de ${debtRatio.toFixed(1).replace('.', ',')}%. La banque pourrait exiger des garanties suppl√©mentaires. Reste √† vivre : ${fmt(remaining)}.`;
            card.classList.add('border-orange-500/30');
        } else {
            ring.setAttribute('stroke', '#ef4444');
            percentEl.classList.remove('text-green-400', 'text-orange-400');
            percentEl.classList.add('text-red-400');
            label.textContent = 'üö´ Projet √† risque';
            label.className = 'text-lg font-bold mb-1 text-red-400';
            desc.textContent = `Endettement de ${debtRatio.toFixed(1).replace('.', ',')}% ‚Äî trop √©lev√©. R√©duisez le prix, augmentez l'apport ou allongez la dur√©e.`;
            card.classList.add('border-red-500/30');
        }
    }

    // ‚îÄ‚îÄ‚îÄ Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateChart(capital, interest, fees, asrdTotal = 0) {
        const hasASRD = asrdTotal > 0;
        const data = hasASRD ? [capital, interest, fees, asrdTotal] : [capital, interest, fees];
        const labels = hasASRD ? ['Capital emprunt√©', 'Int√©r√™ts', 'Frais (notaire, enreg‚Ä¶)', 'Assurance SRD'] : ['Capital emprunt√©', 'Int√©r√™ts', 'Frais (notaire, enreg‚Ä¶)'];
        const colors = hasASRD ? ['#6366f1', '#f59e0b', '#ec4899', '#14b8a6'] : ['#6366f1', '#f59e0b', '#ec4899'];

        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.data.datasets[0].backgroundColor = colors;
            chart.update();
        } else {
            const ctx = document.getElementById('costChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(17,24,39,0.95)',
                            titleColor: '#f9fafb',
                            bodyColor: '#d1d5db',
                            borderColor: '#374151',
                            borderWidth: 1,
                            cornerRadius: 10,
                            padding: 12,
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.label + ': ' + fmt(ctx.raw);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Custom legend
        const legend = document.getElementById('chartLegend');
        const total = data.reduce((a, b) => a + b, 0);
        legend.innerHTML = data.map((val, i) => {
            const pct = total > 0 ? ((val / total) * 100).toFixed(1).replace('.', ',') : '0';
            return `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background:${colors[i]}"></div>
                        <span class="text-gray-400">${labels[i]}</span>
                    </div>
                    <div class="font-semibold result-value">${fmtShort(val)} <span class="text-gray-500 text-xs">(${pct}%)</span></div>
                </div>
            `;
        }).join('');
    }

    function updateChartColors() {
        // Chart colors don't change between themes, so nothing needed here
        if (chart) chart.update();
    }

    // ‚îÄ‚îÄ‚îÄ Fee Breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateFeeBreakdown(d) {
        const el = document.getElementById('feeBreakdown');
        const regionLabel = region === 'bruxelles' ? 'Bruxelles' : 'Wallonie';
        const bc = isDark ? 'border-gray-800' : 'border-gray-200';
        const bc2 = isDark ? 'border-gray-700' : 'border-gray-300';

        let regExplanation = '';
        if (region === 'wallonie') {
            regExplanation = '3% (taux r√©duit hab. propre et unique)';
        } else {
            regExplanation = d.price <= 600000
                ? '12,5% avec abattement (0% sur premiers 200k‚Ç¨)'
                : '12,5% sans abattement (prix > 600k‚Ç¨)';
        }

        // LTV warning
        let ltvWarning = '';
        if (d.ltv > 100) {
            ltvWarning = `<div class="mt-3 rounded-lg bg-red-500/10 border border-red-500/30 px-3 py-2 text-xs text-red-400">‚ö†Ô∏è Quotit√© de ${d.ltv.toFixed(0)}% ‚Äî La plupart des banques belges refusent au-del√† de 100%. Augmentez votre apport.</div>`;
        } else if (d.ltv > 90) {
            ltvWarning = `<div class="mt-3 rounded-lg bg-orange-500/10 border border-orange-500/30 px-3 py-2 text-xs text-orange-400">‚ö†Ô∏è Quotit√© de ${d.ltv.toFixed(0)}% ‚Äî Au-del√† de 90%, les banques exigent souvent un taux plus √©lev√© et des garanties suppl√©mentaires.</div>`;
        } else if (d.ltv > 80) {
            ltvWarning = `<div class="mt-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30 px-3 py-2 text-xs text-yellow-400">üí° Quotit√© de ${d.ltv.toFixed(0)}% ‚Äî Correct pour un premier achat. En-dessous de 80% vous obtiendrez de meilleures conditions.</div>`;
        }

        el.innerHTML = `
            <p class="text-xs text-gray-500 mb-3 leading-relaxed">üìê Frais calcul√©s selon le bar√®me d√©gressif notarial belge (AR 1950) + TVA 21%</p>

            <div class="text-xs font-semibold text-brand-400 uppercase tracking-wider mb-2 mt-1">Acte de vente</div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">R√©gion</span>
                <span class="font-medium">${regionLabel}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">Droits d'enregistrement <span class="text-xs">(${regExplanation})</span></span>
                <span class="font-medium result-value">${fmt(d.registrationFees)}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">Honoraires notaire <span class="text-xs">(bar√®me d√©gressif)</span></span>
                <span class="font-medium result-value">${fmt(d.notary.honoraires)}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">TVA 21% sur honoraires</span>
                <span class="font-medium result-value">${fmt(d.notary.tva)}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">Frais administratifs & recherches</span>
                <span class="font-medium result-value">${fmt(d.notary.admin)}</span>
            </div>

            <div class="text-xs font-semibold text-brand-400 uppercase tracking-wider mb-2 mt-4">Acte hypoth√©caire</div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">Droit d'enregistrement <span class="text-xs">(1% du pr√™t)</span></span>
                <span class="font-medium result-value">${fmt(d.mortgage.registrationTax)}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">Droit d'inscription hypoth√©caire <span class="text-xs">(0,3%)</span></span>
                <span class="font-medium result-value">${fmt(d.mortgage.inscriptionFee)}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">Honoraires notaire (acte cr√©dit)</span>
                <span class="font-medium result-value">${fmt(d.mortgage.honoraires)}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">TVA 21% sur honoraires cr√©dit</span>
                <span class="font-medium result-value">${fmt(d.mortgage.tva)}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">Frais admin. acte cr√©dit</span>
                <span class="font-medium result-value">${fmt(d.mortgage.admin)}</span>
            </div>
            <div class="flex justify-between py-2 ${bc} border-b">
                <span class="text-gray-400">Frais de dossier bancaire</span>
                <span class="font-medium result-value">${fmt(d.mortgage.dossierBank)}</span>
            </div>

            <div class="flex justify-between py-2 ${bc} border-b font-semibold mt-2">
                <span>Total des frais</span>
                <span class="text-brand-400 result-value">${fmt(d.totalFees)}</span>
            </div>

            ${ltvWarning}

            <div class="mt-4 pt-3 ${bc2} border-t">
                <div class="text-xs font-semibold text-brand-400 uppercase tracking-wider mb-2">R√©sum√© du cr√©dit</div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-400">Prix du bien</span>
                    <span class="font-medium result-value">${fmt(d.price)}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-400">Quotit√© (LTV)</span>
                    <span class="font-medium ${d.ltv > 90 ? 'text-red-400' : d.ltv > 80 ? 'text-orange-400' : 'text-green-400'}">${d.ltv.toFixed(1).replace('.', ',')}%</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-400">Taux effectif</span>
                    <span class="font-medium">${d.effectiveRate.toFixed(2).replace('.', ',')}%</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-400">Capital emprunt√©</span>
                    <span class="font-medium result-value">${fmt(d.financingNeed)}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-400">Nombre de mensualit√©s</span>
                    <span class="font-medium">${d.n}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-400">Co√ªt total des int√©r√™ts</span>
                    <span class="font-medium result-value">${fmt(d.totalCredit)}</span>
                </div>
                ${d.asrdEnabled ? `
                <div class="flex justify-between py-1">
                    <span class="text-gray-400">Assurance solde restant d√ª <span class="text-xs">(prime unique)</span></span>
                    <span class="font-medium text-teal-400 result-value">${fmt(d.asrd.singlePremium)}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-400">Mensualit√© cr√©dit + ASRD</span>
                    <span class="font-medium result-value">${fmt(d.monthlyTotal)}</span>
                </div>
                ` : ''}
                <div class="flex justify-between py-1 font-semibold text-base mt-2 pt-2 ${bc2} border-t">
                    <span>Co√ªt total de l'op√©ration</span>
                    <span class="text-brand-400 result-value">${fmt(d.price + d.totalFees + d.totalCredit + (d.asrdEnabled ? d.asrd.singlePremium : 0))}</span>
                </div>
            </div>
        `;
    }

    // ‚îÄ‚îÄ‚îÄ Scenarios ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const scenarioColors = ['#6366f1', '#f59e0b', '#ec4899'];
    const scenarioLabels = ['A', 'B', 'C'];

    function saveScenario() {
        if (!lastCalcResult) return;
        if (savedScenarios.length >= 3) {
            // Replace oldest
            savedScenarios.shift();
        }
        const s = { ...lastCalcResult, id: Date.now() };
        savedScenarios.push(s);
        renderScenarios();
        showToast(`Sc√©nario ${scenarioLabels[(savedScenarios.length - 1) % 3]} sauvegard√© ‚úì`);
    }

    function removeScenario(id) {
        savedScenarios = savedScenarios.filter(s => s.id !== id);
        renderScenarios();
    }

    function clearScenarios() {
        savedScenarios = [];
        renderScenarios();
    }

    function renderScenarios() {
        const section = document.getElementById('scenarioSection');
        const grid = document.getElementById('scenarioGrid');
        const table = document.getElementById('scenarioTable');
        const clearBtn = document.getElementById('clearScenariosBtn');

        if (savedScenarios.length === 0) {
            section.classList.add('hidden');
            clearBtn.classList.add('hidden');
            return;
        }

        section.classList.remove('hidden');
        clearBtn.classList.remove('hidden');
        const bc = isDark ? 'border-gray-700' : 'border-gray-300';
        const bg = isDark ? 'bg-gray-800' : 'bg-gray-100';
        const bgCard = isDark ? 'bg-gray-800/60' : 'bg-gray-100/60';

        // Scenario cards
        grid.style.gridTemplateColumns = `repeat(${savedScenarios.length}, minmax(0, 1fr))`;
        grid.innerHTML = savedScenarios.map((s, i) => {
            const color = scenarioColors[i % 3];
            const label = scenarioLabels[i % 3];
            const debtColor = s.debtRatio < 35 ? 'text-green-400' : s.debtRatio <= 45 ? 'text-orange-400' : 'text-red-400';
            const ltvColor = s.ltv <= 80 ? 'text-green-400' : s.ltv <= 90 ? 'text-orange-400' : 'text-red-400';
            return `
                <div class="scenario-card rounded-xl ${bgCard} border ${bc} p-4 relative">
                    <button onclick="removeScenario(${s.id})" class="scenario-remove absolute top-2 right-2 w-6 h-6 rounded-full bg-gray-700 hover:bg-red-500 text-gray-400 hover:text-white flex items-center justify-center text-xs transition-colors">&times;</button>
                    <div class="flex items-center gap-2 mb-3">
                        <span class="scenario-badge text-white" style="background:${color}">${label}</span>
                        <span class="text-sm font-semibold">${fmtShort(s.price)}</span>
                        <span class="text-xs text-gray-500">${s.region === 'bruxelles' ? 'BXL' : 'WAL'}</span>
                    </div>
                    <div class="space-y-1.5 text-xs">
                        <div class="flex justify-between"><span class="text-gray-400">Mensualit√©</span><span class="font-semibold result-value">${fmt(s.monthlyTotal)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Taux</span><span class="font-medium">${s.rate.toFixed(2).replace('.', ',')}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Dur√©e</span><span class="font-medium">${s.years} ans</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Endettement</span><span class="font-medium ${debtColor}">${s.debtRatio.toFixed(1).replace('.', ',')}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">LTV</span><span class="font-medium ${ltvColor}">${s.ltv.toFixed(0)}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">PEB</span><span class="font-medium">${s.peb}</span></div>
                        ${s.asrdEnabled ? `<div class="flex justify-between"><span class="text-gray-400">ASRD/mois</span><span class="font-medium text-teal-400 result-value">${fmt(s.monthlyASRD)}</span></div>` : ''}
                    </div>
                    <div class="mt-3 pt-2 ${bc} border-t">
                        <div class="flex justify-between text-xs"><span class="text-gray-400">Co√ªt total</span><span class="font-bold text-brand-400 result-value">${fmtShort(s.totalOperation)}</span></div>
                    </div>
                </div>
            `;
        }).join('');

        // Comparison table
        if (savedScenarios.length >= 2) {
            const rows = [
                { label: 'Prix', key: s => fmt(s.price) },
                { label: 'Apport', key: s => fmt(s.downPayment) },
                { label: 'Taux effectif', key: s => s.rate.toFixed(2).replace('.', ',') + '%' },
                { label: 'Dur√©e', key: s => s.years + ' ans' },
                { label: 'Mensualit√© totale', key: s => fmt(s.monthlyTotal), bold: true },
                { label: 'Reste √† vivre', key: s => fmt(s.remaining) },
                { label: 'Endettement', key: s => { const v = s.debtRatio.toFixed(1).replace('.',',')+'%'; const c = s.debtRatio<35?'text-green-400':s.debtRatio<=45?'text-orange-400':'text-red-400'; return `<span class="${c}">${v}</span>`; } },
                { label: 'Quotit√© (LTV)', key: s => { const v = s.ltv.toFixed(0)+'%'; const c = s.ltv<=80?'text-green-400':s.ltv<=90?'text-orange-400':'text-red-400'; return `<span class="${c}">${v}</span>`; } },
                { label: 'Frais totaux', key: s => fmt(s.totalFees) },
                { label: 'Co√ªt int√©r√™ts', key: s => fmt(s.totalCredit) },
                { label: 'ASRD (prime)', key: s => s.asrdEnabled ? fmt(s.asrdSingle) : '‚Äî' },
                { label: 'Co√ªt total op√©ration', key: s => fmt(s.totalOperation), bold: true },
            ];

            // Find best values for highlighting
            const bestMonthly = Math.min(...savedScenarios.map(s => s.monthlyTotal));
            const bestTotal = Math.min(...savedScenarios.map(s => s.totalOperation));

            table.innerHTML = `
                <table class="w-full text-xs">
                    <thead>
                        <tr class="${bc} border-b">
                            <th class="text-left py-2 text-gray-500 font-medium pr-4"></th>
                            ${savedScenarios.map((s, i) => `<th class="text-right py-2 px-2"><span class="scenario-badge text-white text-xs" style="background:${scenarioColors[i]}">${scenarioLabels[i]}</span></th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => `
                            <tr class="${bc} border-b">
                                <td class="py-1.5 text-gray-400 pr-4 ${row.bold ? 'font-semibold' : ''}">${row.label}</td>
                                ${savedScenarios.map(s => `<td class="text-right py-1.5 px-2 result-value ${row.bold ? 'font-semibold' : ''}">${row.key(s)}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p class="text-xs text-gray-500 mt-3">üí° Astuce : modifiez les param√®tres et sauvegardez un nouveau sc√©nario pour comparer.</p>
            `;
        } else {
            table.innerHTML = '<p class="text-xs text-gray-500 mt-2">Sauvegardez au moins 2 sc√©narios pour les comparer.</p>';
        }
    }

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
        // Wallonie par d√©faut ‚Üí toggle NOT active (active = Bruxelles)
        calculate();
    });
</script>

</body>
</html>
